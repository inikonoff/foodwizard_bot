from groq import AsyncGroq
from config import GROQ_API_KEY, GROQ_MODEL, GROQ_MAX_TOKENS
from typing import Dict, List, Union, Optional
import json
import re
import logging

# –ü—Ä–æ—Å—Ç–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è groq==0.9.0
client = AsyncGroq(api_key=GROQ_API_KEY)
logger = logging.getLogger(__name__)

# –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
COMPLEX_MEAL_MIN_INGREDIENTS = 3

class GroqService:
    
    # --- –ë–ê–ó–û–í–´–ô –ú–ï–¢–û–î –ó–ê–ü–†–û–°–ê ---
    @staticmethod
    async def _send_groq_request(system_prompt: str, user_text: str, temperature: float = 0.5, max_tokens: int = 1000) -> str:
        try:
            response = await client.chat.completions.create(
                model=GROQ_MODEL,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_text}
                ],
                max_tokens=max_tokens,
                temperature=temperature
            )
            return response.choices[0].message.content.strip()
        except Exception as e:
            logger.error(f"Groq API Error: {e}")
            return ""

    # --- –õ–û–ì–ò–ö–ê ---

    @staticmethod
    async def validate_ingredients(text: str) -> bool:
        prompt = """–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –º–æ–¥–µ—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤.
        –í–µ—Ä–Ω–∏ JSON: {"valid": true} –ï–°–õ–ò –≤ —Ç–µ–∫—Å—Ç–µ —Å—ä–µ–¥–æ–±–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã.
        –í–µ—Ä–Ω–∏ JSON: {"valid": false} –ï–°–õ–ò –±–µ—Å—Å–º—ã—Å–ª–∏—Ü–∞, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏–ª–∏ –Ω–µ—Å—ä–µ–¥–æ–±–Ω—ã–µ/–æ–ø–∞—Å–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã.
        –í–ï–†–ù–ò –¢–û–õ–¨–ö–û JSON."""
        
        res = await GroqService._send_groq_request(prompt, f"–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π: \"{text}\"", 0.1)
        return "true" in res.lower()

    @staticmethod
    async def analyze_categories(products: str) -> List[str]:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–ª—é–¥ –∏–∑ —ç—Ç–æ–≥–æ –†–ï–ê–õ–¨–ù–û –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å.
        –¢–µ–ø–µ—Ä—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã—Ö –æ–±–µ–¥–æ–≤ (mix).
        """
        # –ü–æ–¥—Å—á–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ mix
        items = [p.strip() for p in re.split(r'[,]', products) if p.strip()]
        items_count = len(items)
        
        prompt = f"""–¢—ã –æ–ø—ã—Ç–Ω—ã–π —à–µ—Ñ-–ø–æ–≤–∞—Ä. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤: "{products}".
        
        –û–ø—Ä–µ–¥–µ–ª–∏, –∫–∞–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–ª—é–¥ –∏–∑ —ç—Ç–æ–≥–æ –†–ï–ê–õ–¨–ù–û –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å (–∏–º–µ—è –±–∞–∑–æ–≤—ã–µ —Å–æ–ª—å/–≤–æ–¥—É/–ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–æ–µ –º–∞—Å–ª–æ/—Å–∞—Ö–∞—Ä/–ª—ë–¥)
           
        –í–æ–∑–º–æ–∂–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:
        - "soup" (—Å—É–ø—ã)
        - "main" (–≤—Ç–æ—Ä—ã–µ –±–ª—é–¥–∞)
        - "salad" (—Å–∞–ª–∞—Ç—ã)
        - "breakfast" (–∑–∞–≤—Ç—Ä–∞–∫–∏)
        - "dessert" (–¥–µ—Å–µ—Ä—Ç—ã - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Å–∞—Ö–∞—Ä/—Ñ—Ä—É–∫—Ç—ã/–º—É–∫–∞/—Å–ª–∏–≤–∫–∏/–¥–∂–µ–º—ã/–≤–∞—Ä–µ–Ω—å–µ)
        - "drink" (–Ω–∞–ø–∏—Ç–∫–∏ - —Å–º—É–∑–∏, –º–æ—Ä—Å—ã, –∫–æ–∫—Ç–µ–π–ª–∏ - –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ—Ä—É–∫—Ç—ã/–º–æ–ª–æ–∫–æ/—è–≥–æ–¥—ã)
        - "snack" (–∑–∞–∫—É—Å–∫–∏)
        - "sauce" (—Å–æ—É—Å—ã - –±–µ—à–∞–º–µ–ª—å, –≤–µ–ª—É—Ç–µ, –¥–µ–º–∏–≥–ª–∞—Å, —Ç–æ–º–∞—Ç–Ω—ã–π, –≥–æ–ª–ª–∞–Ω–¥—Å–∫–∏–π, –∫—É–ª–∏, —Ñ–æ–Ω–¥—é, —Ä–æ–º–µ—Å–∫–æ, –æ–≤–æ—â–Ω–æ–π)
        
        –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û: –æ–ø—Ä–µ–¥–µ–ª–∏, –º–æ–∂–Ω–æ –ª–∏ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ö–û–ú–ü–õ–ï–ö–°–ù–´–ô –û–ë–ï–î –∏–∑ —ç—Ç–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤.
        –ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –æ–±–µ–¥–∞:
        1. –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ (–º–∏–Ω–∏–º—É–º {COMPLEX_MEAL_MIN_INGREDIENTS} —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤)
        2. –ï—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è –º–∏–Ω–∏–º—É–º 2 —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –±–ª—é–¥
        3. –ú–æ–∂–Ω–æ —Å–æ—Å—Ç–∞–≤–∏—Ç—å —Å–≤—è–∑–Ω–æ–µ –º–µ–Ω—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: —Å—É–ø + –≤—Ç–æ—Ä–æ–µ + –Ω–∞–ø–∏—Ç–æ–∫)
        
        –í–ï–†–ù–ò –¢–û–õ–¨–ö–û JSON —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π. –ï—Å–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –æ—á–µ–Ω—å –º–∞–ª–æ, –≤–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Å–∞–º—É—é –ø–æ–¥—Ö–æ–¥—è—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é.
        
        –ü—Ä–∏–º–µ—Ä—ã:
        ["main", "salad", "drink"]
        ["soup", "main", "mix_simple"]   # –ü—Ä–æ—Å—Ç–æ–π –∫–æ–º–ø–ª–µ–∫—Å (2 –±–ª—é–¥–∞)
        ["soup", "main", "salad", "mix_standard"]  # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å (3 –±–ª—é–¥–∞)
        ["soup", "salad", "main", "drink", "mix_full"]  # –ü–æ–ª–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å (4+ –±–ª—é–¥–∞)
        """
        
        res = await GroqService._send_groq_request(prompt, "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏", 0.2)
        
        try:
            # –û—á–∏—Å—Ç–∫–∞ –æ—Ç –º–∞—Ä–∫–¥–∞—É–Ω–∞, –∫–æ—Ç–æ—Ä—ã–π –ª—é–±–∏—Ç Groq
            clean_json = res.replace("```json", "").replace("```", "").strip()
            data = json.loads(clean_json)
            if isinstance(data, list):
                return data
        except Exception as e:
            logger.error(f"Category JSON Error: {e}")
            pass
        
        # Fallback: –¥–æ–±–∞–≤–ª—è–µ–º mix –µ—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        if items_count >= COMPLEX_MEAL_MIN_INGREDIENTS:
            if items_count >= 8:
                return ["main", "mix_full"]
            elif items_count >= 5:
                return ["main", "mix_standard"]
            else:
                return ["main", "mix_simple"]
        
        return ["main"]

    @staticmethod
    async def generate_dishes_list(products: str, category: str, style: str = "–æ–±—ã—á–Ω—ã–π") -> List[Dict[str, str]]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –±–ª—é–¥. –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å mix_ - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ –æ–±–µ–¥—ã.
        """
        # –ï—Å–ª–∏ —ç—Ç–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –æ–±–µ–¥–∞
        if category.startswith("mix_"):
            complexity = category.split("_")[1]  # simple, standard, full
            complex_meals = await GroqService.generate_complex_meals(products, complexity, style)
            return complex_meals
        
        # –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        items_count = len(re.split(r'[,]', products))
        
        if items_count <= 2:
            target_count = "2-3"
            complexity = "–ø—Ä–æ—Å—Ç—ã—Ö"
        elif items_count <= 5:
            target_count = "4-5"
            complexity = "—Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã—Ö"
        else:
            target_count = "5-6"
            complexity = "–∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö"

        # –ö–∞—Ä—Ç–∞ –Ω–∞–∑–≤–∞–Ω–∏–π
        cat_names = {
            "soup": "–°—É–ø—ã", "main": "–í—Ç–æ—Ä—ã–µ –±–ª—é–¥–∞", "salad": "–°–∞–ª–∞—Ç—ã", "sauce": "–°–æ—É—Å—ã",
            "breakfast": "–ó–∞–≤—Ç—Ä–∞–∫–∏", "dessert": "–î–µ—Å–µ—Ä—Ç—ã", "drink": "–ù–∞–ø–∏—Ç–∫–∏", "snack": "–ó–∞–∫—É—Å–∫–∏",
            "mix_simple": "–ü—Ä–æ—Å—Ç–æ–π –∫–æ–º–ø–ª–µ–∫—Å", "mix_standard": "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å", "mix_full": "–ü–æ–ª–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å"
        }
        cat_ru = cat_names.get(category, "–ë–ª—é–¥–∞")

        prompt = f"""–¢—ã —à–µ—Ñ-–ø–æ–≤–∞—Ä. –ü—Ä–æ–¥—É–∫—Ç—ã: {products}.
        –ó–∞–¥–∞—á–∞: –ü—Ä–∏–¥—É–º–∞–π {target_count} {complexity} –±–ª—é–¥ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: "{cat_ru}". –°—Ç–∏–ª—å: {style}.
        
        –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è "–ù–∞–ø–∏—Ç–∫–∏" - –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–º—É–∑–∏, –º–æ—Ä—Å—ã, –∫–æ–∫—Ç–µ–π–ª–∏.
        
        –í–ï–†–ù–ò –°–¢–†–û–ì–û JSON —Ñ–æ—Ä–º–∞—Ç (—Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤), –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤:
        [
            {{"name": "–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞", "desc": "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"}}
        ]
        """
        
        res = await GroqService._send_groq_request(prompt, "–ü—Ä–µ–¥–ª–æ–∂–∏ –º–µ–Ω—é JSON", 0.5)
        
        try:
            clean_json = res.replace("```json", "").replace("```", "").strip()
            data = json.loads(clean_json)
            if isinstance(data, list):
                return data
        except Exception as e:
            logger.error(f"Dishes JSON Error: {e}")
        return []

    @staticmethod
    async def generate_complex_meals(products: str, complexity: str = "standard", style: str = "–æ–±—ã—á–Ω—ã–π") -> List[Dict[str, str]]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ –æ–±–µ–¥—ã.
        complexity: simple (2 –±–ª—é–¥–∞), standard (3 –±–ª—é–¥–∞), full (4 –±–ª—é–¥–∞)
        """
        complexity_config = {
            "simple": {
                "name": "–ü—Ä–æ—Å—Ç–æ–π –∫–æ–º–ø–ª–µ–∫—Å",
                "courses_count": 2,
                "structure": ["–û—Å–Ω–æ–≤–Ω–æ–µ –±–ª—é–¥–æ", "–ù–∞–ø–∏—Ç–æ–∫ –∏–ª–∏ –∑–∞–∫—É—Å–∫–∞"]
            },
            "standard": {
                "name": "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å",
                "courses_count": 3,
                "structure": ["–°—É–ø", "–û—Å–Ω–æ–≤–Ω–æ–µ –±–ª—é–¥–æ", "–ù–∞–ø–∏—Ç–æ–∫"]
            },
            "full": {
                "name": "–ü–æ–ª–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å",
                "courses_count": 4,
                "structure": ["–°—É–ø", "–°–∞–ª–∞—Ç", "–û—Å–Ω–æ–≤–Ω–æ–µ –±–ª—é–¥–æ", "–ù–∞–ø–∏—Ç–æ–∫"]
            }
        }
        
        config = complexity_config.get(complexity, complexity_config["standard"])
        
        prompt = f"""–¢—ã —à–µ—Ñ-—Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞. –ü—Ä–æ–¥—É–∫—Ç—ã: {products}.
        
        –ó–∞–¥–∞—á–∞: –°–æ–∑–¥–∞–π 2-3 –ö–û–ú–ü–õ–ï–ö–°–ù–´–• –û–ë–ï–î–ê ({config['name']}).
        –°—Ç—Ä—É–∫—Ç—É—Ä–∞: {', '.join(config['structure'])}
        –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª—é–¥ –≤ –∫–æ–º–ø–ª–µ–∫—Å–µ: {config['courses_count']}
        –°—Ç–∏–ª—å: {style}
        
        –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
        1. –ö–∞–∂–¥—ã–π –∫–æ–º–ø–ª–µ–∫—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ª–æ–≥–∏—á–Ω—ã–º (–±–ª—é–¥–∞ —Å–æ—á–µ—Ç–∞—é—Ç—Å—è –º–µ–∂–¥—É —Å–æ–±–æ–π)
        2. –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –±–ª—é–¥ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ –∫–æ–º–ø–ª–µ–∫—Å–∞
        3. –£—á–∏—Ç—ã–≤–∞–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥–∞—á–∏
        4. –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –±–ª—é–¥–∞ –≤ —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–ø–ª–µ–∫—Å–∞—Ö
        5. –†–∞—Å—Å—á–∏—Ç–∞–π –æ–±—â–µ–µ –≤—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–µ–Ω–∏—è
        
        –í–ï–†–ù–ò –°–¢–†–û–ì–û JSON —Ñ–æ—Ä–º–∞—Ç (—Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤):
        [
            {{
                "name": "–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–ª–µ–∫—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–°–µ–º–µ–π–Ω—ã–π –æ–±–µ–¥', '–õ–µ–≥–∫–∏–π —É–∂–∏–Ω')",
                "description": "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–ø–ª–µ–∫—Å–∞",
                "complexity": "{complexity}",
                "courses": [
                    {{"type": "soup|main|salad|drink|appetizer|dessert", 
                      "name": "–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞", 
                      "description": "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –±–ª—é–¥–∞"}}
                ],
                "total_time": "XX –º–∏–Ω—É—Ç",
                "servings": "X –ø–µ—Ä—Å–æ–Ω"
            }}
        ]
        
        –£–±–µ–¥–∏—Å—å —á—Ç–æ –≤ –∫–∞–∂–¥–æ–º –∫–æ–º–ø–ª–µ–∫—Å–µ –†–û–í–ù–û {config['courses_count']} –±–ª—é–¥–∞.
        """
        
        res = await GroqService._send_groq_request(prompt, "–°–æ–∑–¥–∞–π –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ –æ–±–µ–¥—ã JSON", 0.6)
        
        try:
            clean_json = res.replace("```json", "").replace("```", "").strip()
            data = json.loads(clean_json)
            if isinstance(data, list):
                # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–ª—è –µ–¥–∏–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                formatted_meals = []
                for meal in data:
                    formatted_meals.append({
                        "name": meal.get("name", "–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –æ–±–µ–¥"),
                        "desc": meal.get("description", ""),
                        "type": "complex",  # –ú–∞—Ä–∫–µ—Ä –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
                        "complex_data": meal  # –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    })
                return formatted_meals
        except Exception as e:
            logger.error(f"Complex Meals JSON Error: {e}")
        
        # Fallback: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
        return []

    @staticmethod
    async def generate_complex_recipe(complex_meal: Dict, products: str) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–µ—Ü–µ–ø—Ç –¥–ª—è –≤—Å–µ–≥–æ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –æ–±–µ–¥–∞.
        """
        prompt = f"""–¢—ã —à–µ—Ñ-–ø–æ–≤–∞—Ä —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞. –°–æ–∑–¥–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–π –ø–ª–∞–Ω –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –ö–û–ú–ü–õ–ï–ö–°–ù–û–ì–û –û–ë–ï–î–ê:
        
        –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–ª–µ–∫—Å–∞: {complex_meal.get('name', '–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –æ–±–µ–¥')}
        
        –°–æ—Å—Ç–∞–≤ –∫–æ–º–ø–ª–µ–∫—Å–∞:
        {json.dumps(complex_meal.get('courses', []), ensure_ascii=False, indent=2)}
        
        –û–±—â–µ–µ –≤—Ä–µ–º—è: {complex_meal.get('total_time', '60')} –º–∏–Ω—É—Ç
        –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä—Å–æ–Ω: {complex_meal.get('servings', '4')}
        
        –ò–º–µ—é—â–∏–µ—Å—è –ø—Ä–æ–¥—É–∫—Ç—ã: {products}
        –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã: —Å–æ–ª—å, –≤–æ–¥–∞, –ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–æ–µ –º–∞—Å–ª–æ, —Å–∞—Ö–∞—Ä, –ª–µ–¥
        
        –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
        1. –ü—Ä–µ–¥–ª–æ–∂–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è (—á—Ç–æ –≥–æ—Ç–æ–≤–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
        2. –†–∞—Å—Å—á–∏—Ç–∞–π —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞
        3. –£–∫–∞–∂–∏, –∫–∞–∫–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –±–ª—é–¥–∞—Ö
        4. –î–∞–π —Å–æ–≤–µ—Ç—ã –ø–æ —Å–µ—Ä–≤–∏—Ä–æ–≤–∫–µ –∏ –ø–æ–¥–∞—á–µ
        5. –†–∞—Å—Å—á–∏—Ç–∞–π –æ–±—â—É—é –ø–∏—â–µ–≤—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å –≤—Å–µ–≥–æ –æ–±–µ–¥–∞
        
        –§–û–†–ú–ê–¢ –í–´–í–û–î–ê:
        ## üçΩÔ∏è –ö–û–ú–ü–õ–ï–ö–°–ù–´–ô –û–ë–ï–î: [–ù–∞–∑–≤–∞–Ω–∏–µ]
        
        ### üìã –°–æ—Å—Ç–∞–≤ –æ–±–µ–¥–∞:
        [–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –±–ª—é–¥ —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏]
        
        ### üïê –ü–õ–ê–ù –ü–†–ò–ì–û–¢–û–í–õ–ï–ù–ò–Ø:
        **–û–±—â–µ–µ –≤—Ä–µ–º—è: XX –º–∏–Ω—É—Ç**
        
        **–≠—Ç–∞–ø—ã:**
        1. [–ü–µ—Ä–≤–æ–µ —á—Ç–æ –¥–µ–ª–∞—Ç—å, –≤—Ä–µ–º—è]
        2. [–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ..., –≤—Ä–µ–º—è]
        3. [–ó–∞—Ç–µ–º..., –≤—Ä–µ–º—è]
        
        ### üìä –ü–ò–©–ï–í–ê–Ø –¶–ï–ù–ù–û–°–¢–¨ (–Ω–∞ 1 –ø–µ—Ä—Å–æ–Ω—É):
        –ë–µ–ª–∫–∏: XX –≥
        –ñ–∏—Ä—ã: XX –≥
        –£–≥–ª–µ–≤–æ–¥—ã: XX –≥
        –≠–Ω–µ—Ä–≥. —Ü–µ–Ω–Ω–æ—Å—Ç—å: XXX –∫–∫–∞–ª
        
        ### üë®‚Äçüç≥ –°–û–í–ï–¢–´ –®–ï–§–ê:
        [–°–æ–≤–µ—Ç—ã –ø–æ —Å–µ—Ä–≤–∏—Ä–æ–≤–∫–µ, —Å–æ—á–µ—Ç–∞–Ω–∏—è–º, –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–¥–∞—á–∏]
        
        ### üí° –ö–£–õ–ò–ù–ê–†–ù–ê–Ø –¢–†–ò–ê–î–ê –ö–û–ú–ü–õ–ï–ö–°–ê:
        [–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤–µ—Å—å –∫–æ–º–ø–ª–µ–∫—Å –Ω–∞ –±–∞–ª–∞–Ω—Å –≤–∫—É—Å–æ–≤, —Ç–µ–∫—Å—Ç—É—Ä –∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä. 
         –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å? –ü–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π –û–î–ù–û –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞.]
        """
        
        res = await GroqService._send_groq_request(prompt, "–ù–∞–ø–∏—à–∏ –ø–ª–∞–Ω –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –∫–æ–º–ø–ª–µ–∫—Å–∞", 0.5)
        if GroqService._is_refusal(res):
            return res
        
        return res + "\n\nüë®‚Äçüç≥ <b>–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞!</b>"

    @staticmethod
    async def determine_intent(user_message: str, dish_list: str) -> Dict:
        prompt = f"""–ö–æ–Ω—Ç–µ–∫—Å—Ç: {dish_list}
        –°–æ–æ–±—â–µ–Ω–∏–µ: "{user_message}"
        –û–ø—Ä–µ–¥–µ–ª–∏ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ:
        1. "add_products" (–¥–æ–±–∞–≤–∏–ª –ø—Ä–æ–¥—É–∫—Ç—ã, –∏–∑–º–µ–Ω–∏–ª —É—Å–ª–æ–≤–∏—è)
        2. "select_dish" (–Ω–∞–∑–≤–∞–ª –±–ª—é–¥–æ —Ç–µ–∫—Å—Ç–æ–º)
        3. "unclear"
        JSON: {{"intent": "...", "products": "...", "dish_name": "..."}}"""

        res = await GroqService._send_groq_request(prompt, "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π", 0.1)
        
        try:
            start = res.find('{')
            end = res.rfind('}')
            if start != -1 and end != -1:
                return json.loads(res[start:end + 1])
        except Exception:
            pass
        return {"intent": "unclear"}
            
    @staticmethod
    async def generate_recipe(dish_name: str, products: str) -> str:
        prompt = f"""–ù–∞–ø–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç: "{dish_name}".

–ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û –≠–¢–ò –ü–†–û–î–£–ö–¢–´: {products}
–ú–û–ñ–ù–û –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –ë–ê–ó–û–í–´–ï: —Å–æ–ª—å, –≤–æ–¥–∞, –ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–æ–µ –º–∞—Å–ª–æ, —Å–∞—Ö–∞—Ä, –ª–µ–¥

**–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:**
1. –ì–æ—Ç–æ–≤–∏–º –°–¢–†–û–ì–û –∏–∑ –∏–º–µ—é—â–∏—Ö—Å—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ç–æ, —á–µ–≥–æ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ –≤—ã—à–µ)
2. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å—Ä–∞–∑—É –≤—Å–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã, –∞ –¢–û–õ–¨–ö–û –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è —ç—Ç–æ–≥–æ –±–ª—é–¥–∞
3. –í —Å–ø–∏—Å–∫–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ —É–∫–∞–∑—ã–≤–∞–π –¢–û–õ–¨–ö–û –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã (–±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ ‚úÖ/üõí)
4. –†–∞—Å—Å—á–∏—Ç–∞–π –ø–∏—â–µ–≤—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å –¢–û–õ–¨–ö–û –¥–ª—è –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
5. –ò—Å–ø–æ–ª—å–∑—É–π –†–ê–ó–ù–û–û–ë–†–ê–ó–ù–´–ï –ï–î–ò–ù–ò–¶–´ –ò–ó–ú–ï–†–ï–ù–ò–Ø –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ–¥—É–∫—Ç–∞:
   - –î–ª—è –º—è—Å–∞/—Ä—ã–±—ã/—Å—ã—Ä–∞: –≥—Ä–∞–º–º—ã (–≥)
   - –î–ª—è –æ–≤–æ—â–µ–π/—Ñ—Ä—É–∫—Ç–æ–≤: —à—Ç—É–∫–∏ (—à—Ç.), –∑—É–±—á–∏–∫–∏ (–¥–ª—è —á–µ—Å–Ω–æ–∫–∞)
   - –î–ª—è —Ö–ª–µ–±–∞: –ª–æ–º—Ç–∏–∫–∏, –∫—É—Å–æ—á–∫–∏
   - –î–ª—è –∂–∏–¥–∫–æ—Å—Ç–µ–π: –º–∏–ª–ª–∏–ª–∏—Ç—Ä—ã (–º–ª), —Å—Ç–æ–ª–æ–≤—ã–µ –ª–æ–∂–∫–∏ (—Å—Ç. –ª.), —á–∞–π–Ω—ã–µ –ª–æ–∂–∫–∏ (—á. –ª.)
   - –î–ª—è —Å–ø–µ—Ü–∏–π: –ø–æ –≤–∫—É—Å—É, —â–µ–ø–æ—Ç–∫–∏
   - –î–ª—è –º–∞—Å–ª–∞: –¥–ª—è –∂–∞—Ä–∫–∏, –¥–ª—è —Å–º–∞–∑—ã–≤–∞–Ω–∏—è —Ñ–æ—Ä–º—ã

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ñ–æ—Ä–º–∞—Ç—É:**
1. –í –Ω–∞—á–∞–ª–µ —É–∫–∞–∂–∏ —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞
2. –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–æ–º —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ –ü–û–î–•–û–î–Ø–©–ò–• –ï–î–ò–ù–ò–¶–ê–•:
   - [–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç] ‚Äî [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –µ–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è];
3. –†–∞—Å—Å—á–∏—Ç–∞–π –ø–∏—â–µ–≤—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å (–ö–ë–ñ–£) –Ω–∞ 1 –ø–æ—Ä—Ü–∏—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
   –ë–µ–ª–∫–∏: X –≥
   –ñ–∏—Ä—ã: X –≥
   –£–≥–ª–µ–≤–æ–¥—ã: X –≥
   –≠–Ω–µ—Ä–≥. —Ü–µ–Ω–Ω–æ—Å—Ç—å: X –∫–∫–∞–ª
4. –£–∫–∞–∂–∏:
   - –í—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –≤ –º–∏–Ω—É—Ç–∞—Ö
   - –°–ª–æ–∂–Ω–æ—Å—Ç—å: –ª–µ–≥–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/—Å–ª–æ–∂–Ω–∞—è
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ä—Ü–∏–π
5. –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ø–æ—à–∞–≥–æ–≤–æ–µ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ
6. –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å "–°–æ–≤–µ—Ç –æ—Ç —à–µ—Ñ–∞ (–ö—É–ª–∏–Ω–∞—Ä–Ω–∞—è —Ç—Ä–∏–∞–¥–∞):"

**–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞:**
## [–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞]

–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:
* [–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç 1] ‚Äî [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –µ–¥–∏–Ω–∏—Ü–∞];
* [–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç 2] ‚Äî [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –µ–¥–∏–Ω–∏—Ü–∞];

### –ü–∏—â–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ 1 –ø–æ—Ä—Ü–∏—é:
–ë–µ–ª–∫–∏: X –≥
–ñ–∏—Ä—ã: X –≥
–£–≥–ª–µ–≤–æ–¥—ã: X –≥
–≠–Ω–µ—Ä–≥. —Ü–µ–Ω–Ω–æ—Å—Ç—å: X –∫–∫–∞–ª

### –í—Ä–µ–º—è:
X –º–∏–Ω—É—Ç
–°–ª–æ–∂–Ω–æ—Å—Ç—å: [–ª–µ–≥–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/—Å–ª–æ–∂–Ω–∞—è]
–ü–æ—Ä—Ü–∏–∏: X —á–µ–ª–æ–≤–µ–∫

### –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:
[–ü–æ—à–∞–≥–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞]

### –°–æ–≤–µ—Ç –æ—Ç —à–µ—Ñ–∞ (–ö—É–ª–∏–Ω–∞—Ä–Ω–∞—è —Ç—Ä–∏–∞–¥–∞):
[–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ –±–ª—é–¥–æ –Ω–∞ –±–∞–ª–∞–Ω—Å –≤–∫—É—Å–æ–≤ (–ñ–∏—Ä–Ω–æ–µ, –ö–∏—Å–ª–æ–µ, –°–æ–ª–µ–Ω–æ–µ, –°–ª–∞–¥–∫–æ–µ, –û—Å—Ç—Ä–æ–µ) –∏ —Ç–µ–∫—Å—Ç—É—Ä (–ú—è–≥–∫–æ–µ/–•—Ä—É—Å—Ç—è—â–µ–µ). –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π —Å–æ–≤–µ—Ç: —á–µ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–ª—è –∏–¥–µ–∞–ª–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∫—É–ª–∏–Ω–∞—Ä–Ω–æ–π —Ç—Ä–∏–∞–¥—ã. –ü–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π –¢–û–õ–¨–ö–û –û–î–ò–ù –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç! –ü—Ä–∏–º–µ—Ä: "–ë–ª—é–¥–æ –≤—ã—à–ª–æ –∂–∏—Ä–Ω—ã–º –∏ –º—è–≥–∫–∏–º. –î–æ–±–∞–≤—å—Ç–µ –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ –º–∞—Ä–∏–Ω–æ–≤–∞–Ω–Ω—ã–π –ª—É–∫ (–∫–∏—Å–ª–æ—Ç–∞/—Ö—Ä—É—Å—Ç)."]"""

        res = await GroqService._send_groq_request(prompt, "–ù–∞–ø–∏—à–∏ —Ä–µ—Ü–µ–ø—Ç —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª", 0.6)
        if GroqService._is_refusal(res): 
            return res
        return res + "\n\nüë®‚Äçüç≥ <b>–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞!</b>"

    @staticmethod
    async def generate_freestyle_recipe(dish_name: str) -> str:
        prompt = f"""–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç —Ä–µ—Ü–µ–ø—Ç: "{dish_name}".
        
        **–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:**
        1. –ï—Å–ª–∏ —ç—Ç–æ –ï–î–ê -> –ù–∞–ø–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º –Ω–∏–∂–µ —Ñ–æ—Ä–º–∞—Ç–µ
        2. –ï—Å–ª–∏ —ç—Ç–æ –ê–ë–°–¢–†–ê–ö–¶–ò–Ø (—Å—á–∞—Å—Ç—å–µ, –ª—é–±–æ–≤—å, —É—Å–ø–µ—Ö) -> –ù–∞–ø–∏—à–∏ –º–µ—Ç–∞—Ñ–æ—Ä–∏—á–µ—Å–∫–∏–π —Ä–µ—Ü–µ–ø—Ç –≤ —Ç–æ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–µ
        3. –ï—Å–ª–∏ —ç—Ç–æ –û–ü–ê–°–ù–û–ï/–ó–ê–ü–†–ï–©–ï–ù–ù–û–ï (–Ω–∞—Ä–∫–æ—Ç–∏–∫–∏, –æ—Ä—É–∂–∏–µ, —è–¥—ã, –Ω–∞—Å–∏–ª–∏–µ) -> 
           –û—Ç–≤–µ—Ç—å –°–¢–†–û–ì–û: "‚õî –ò–∑–≤–∏–Ω–∏—Ç–µ, —è –≥–æ—Ç–æ–≤–ª—é —Ç–æ–ª—å–∫–æ –µ–¥—É."
        
        **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ñ–æ—Ä–º–∞—Ç—É:**
        1. –í –Ω–∞—á–∞–ª–µ —É–∫–∞–∂–∏ —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞/–ø–æ–Ω—è—Ç–∏—è
        2. –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–æ–º —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ –ü–û–î–•–û–î–Ø–©–ò–• –ï–î–ò–ù–ò–¶–ê–•:
           - [–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç] ‚Äî [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –µ–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è];
        3. –ï—Å–ª–∏ —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–µ –±–ª—é–¥–æ, —Ä–∞—Å—Å—á–∏—Ç–∞–π –ø–∏—â–µ–≤—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å (–ö–ë–ñ–£) –Ω–∞ 1 –ø–æ—Ä—Ü–∏—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
           –ë–µ–ª–∫–∏: X –≥
           –ñ–∏—Ä—ã: X –≥
           –£–≥–ª–µ–≤–æ–¥—ã: X –≥
           –≠–Ω–µ—Ä–≥. —Ü–µ–Ω–Ω–æ—Å—Ç—å: X –∫–∫–∞–ª
           (–ï—Å–ª–∏ –º–µ—Ç–∞—Ñ–æ—Ä–∏—á–µ—Å–∫–∏–π —Ä–µ—Ü–µ–ø—Ç - –ø—Ä–æ–ø—É—Å—Ç–∏ —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª)
        4. –£–∫–∞–∂–∏:
           - –í—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –≤ –º–∏–Ω—É—Ç–∞—Ö (–∏–ª–∏ "–≤—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è" –¥–ª—è –º–µ—Ç–∞—Ñ–æ—Ä)
           - –°–ª–æ–∂–Ω–æ—Å—Ç—å: –ª–µ–≥–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/—Å–ª–æ–∂–Ω–∞—è
           - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ä—Ü–∏–π
        5. –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ø–æ—à–∞–≥–æ–≤–æ–µ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ/—Å–æ–∑–¥–∞–Ω–∏–µ
        6. –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å "–°–æ–≤–µ—Ç –æ—Ç —à–µ—Ñ–∞ (–ö—É–ª–∏–Ω–∞—Ä–Ω–∞—è —Ç—Ä–∏–∞–¥–∞):" (–∏–ª–∏ "–°–æ–≤–µ—Ç –æ—Ç —Ñ–∏–ª–æ—Å–æ—Ñ–∞:" –¥–ª—è –º–µ—Ç–∞—Ñ–æ—Ä)

        **–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞:**
        ## [–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞/–ø–æ–Ω—è—Ç–∏—è]

        –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:
        * [–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç 1] ‚Äî [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –µ–¥–∏–Ω–∏—Ü–∞];
        * [–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç 2] ‚Äî [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –µ–¥–∏–Ω–∏—Ü–∞];

        ### –ü–∏—â–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ 1 –ø–æ—Ä—Ü–∏—é:
        –ë–µ–ª–∫–∏: X –≥
        –ñ–∏—Ä—ã: X –≥
        –£–≥–ª–µ–≤–æ–¥—ã: X –≥
        –≠–Ω–µ—Ä–≥. —Ü–µ–Ω–Ω–æ—Å—Ç—å: X –∫–∫–∞–ª
        (–ü—Ä–æ–ø—É—Å—Ç–∏ –¥–ª—è –º–µ—Ç–∞—Ñ–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤)

        ### –í—Ä–µ–º—è:
        X –º–∏–Ω—É—Ç
        –°–ª–æ–∂–Ω–æ—Å—Ç—å: [–ª–µ–≥–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/—Å–ª–æ–∂–Ω–∞—è]
        –ü–æ—Ä—Ü–∏–∏: X —á–µ–ª–æ–≤–µ–∫

        ### –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:
        [–ü–æ—à–∞–≥–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞]

        ### –°–æ–≤–µ—Ç –æ—Ç —à–µ—Ñ–∞ (–ö—É–ª–∏–Ω–∞—Ä–Ω–∞—è —Ç—Ä–∏–∞–¥–∞):
        [–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ –±–ª—é–¥–æ –Ω–∞ –±–∞–ª–∞–Ω—Å –≤–∫—É—Å–æ–≤ (–ñ–∏—Ä–Ω–æ–µ, –ö–∏—Å–ª–æ–µ, –°–æ–ª–µ–Ω–æ–µ, –°–ª–∞–¥–∫–æ–µ, –û—Å—Ç—Ä–æ–µ) –∏ —Ç–µ–∫—Å—Ç—É—Ä (–ú—è–≥–∫–æ–µ/–•—Ä—É—Å—Ç—è—â–µ–µ). –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π —Å–æ–≤–µ—Ç: —á–µ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–ª—è –∏–¥–µ–∞–ª–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∫—É–ª–∏–Ω–∞—Ä–Ω–æ–π —Ç—Ä–∏–∞–¥—ã. –ü–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π –¢–û–õ–¨–ö–û –û–î–ò–ù –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç!]
        
        **–ï—Å–ª–∏ —ç—Ç–æ –º–µ—Ç–∞—Ñ–æ—Ä–∞ (—Å—á–∞—Å—Ç—å–µ, –ª—é–±–æ–≤—å –∏ —Ç.–¥.):**
        ### –°–æ–≤–µ—Ç –æ—Ç —Ñ–∏–ª–æ—Å–æ—Ñ–∞:
        [–î–∞–π –∫–æ—Ä–æ—Ç–∫–∏–π —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π —Å–æ–≤–µ—Ç –ø–æ —É–ª—É—á—à–µ–Ω–∏—é/–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—é —ç—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è]"""

        res = await GroqService._send_groq_request(prompt, "–ù–∞–ø–∏—à–∏ —Ä–µ—Ü–µ–ø—Ç —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª", 0.6)
        if GroqService._is_refusal(res): 
            return res
        return res + "\n\nüë®‚Äçüç≥ <b>–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞!</b>"

    @staticmethod
    def _is_refusal(text: str) -> bool:
        if "‚õî" in text: 
            return True
        refusals = ["cannot fulfill", "cannot answer", "against my policy", "–Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å", "–Ω–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞"]
        for ph in refusals:
            if ph in text.lower(): 
                return True
        return False