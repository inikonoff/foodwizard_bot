from groq import Groq
from config import GROQ_API_KEY, GROQ_MODEL, GROQ_MAX_TOKENS
from typing import List, Dict

client = Groq(api_key=GROQ_API_KEY)

class GroqService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Groq API"""
    
    @staticmethod
    async def generate_dishes(products: str) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –±–ª—é–¥ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤"""
        prompt = f"""–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã: {products}

–ü—Ä–µ–¥–ª–æ–∂–∏ 3-5 –±–ª—é–¥, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å –∏–∑ –ß–ê–°–¢–ò —ç—Ç–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ —Å—Ä–∞–∑—É).

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
üçΩÔ∏è –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞
–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤ –æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ - –≤—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è

–í–∞–∂–Ω–æ:
- –ë–ª—é–¥–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏ –∏ –ø–æ–ø—É–ª—è—Ä–Ω—ã–º–∏
- –ù–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã –≤ –∫–∞–∂–¥–æ–º –±–ª—é–¥–µ
- –£–∫–∞–∑—ã–≤–∞–π –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
- –ü–∏—à–∏ –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É

–ü–æ—Å–ª–µ —Å–ø–∏—Å–∫–∞ –±–ª—é–¥ –¥–æ–±–∞–≤—å:
üí° –ú–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã –≥–æ–ª–æ—Å–æ–º –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –º–µ–Ω—é –∏–ª–∏ —Å—Ä–∞–∑—É –≤—ã–±—Ä–∞—Ç—å –±–ª—é–¥–æ

üé§ –ù–∞–∑–æ–≤–∏—Ç–µ –±–ª—é–¥–æ –∏–ª–∏ –ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è"""

        response = client.chat.completions.create(
            model=GROQ_MODEL,
            messages=[{"role": "user", "content": prompt}],
            max_tokens=GROQ_MAX_TOKENS,
            temperature=0.7
        )
        
        return response.choices[0].message.content
    
    @staticmethod
    async def determine_intent(user_message: str, dish_list: str) -> Dict:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –≤—ã–±–æ—Ä –±–ª—é–¥–∞ –∏–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤"""
        prompt = f"""–¢—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫—É–ª–∏–Ω–∞—Ä–Ω–æ–≥–æ –±–æ—Ç–∞. –†–∞–Ω–µ–µ –±—ã–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω—ã –±–ª—é–¥–∞:

{dish_list}

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª: "{user_message}"

–û–ø—Ä–µ–¥–µ–ª–∏ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
1. –ï—Å–ª–∏ –æ–Ω –≤—ã–±–∏—Ä–∞–µ—Ç –±–ª—é–¥–æ –∏–∑ —Å–ø–∏—Å–∫–∞ (–Ω–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ, –Ω–æ–º–µ—Ä –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ) - –≤–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON:
{{"intent": "select_dish", "dish_name": "—Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ –∏–∑ —Å–ø–∏—Å–∫–∞"}}

2. –ï—Å–ª–∏ –æ–Ω –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã - –≤–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON:
{{"intent": "add_products", "products": "—Å–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é"}}

3. –ï—Å–ª–∏ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ - –≤–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON:
{{"intent": "unclear"}}

–í–ï–†–ù–ò –¢–û–õ–¨–ö–û JSON, –ë–ï–ó –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û–ì–û –¢–ï–ö–°–¢–ê."""

        response = client.chat.completions.create(
            model=GROQ_MODEL,
            messages=[{"role": "user", "content": prompt}],
            max_tokens=200,
            temperature=0.3
        )
        
        import json
        result = response.choices[0].message.content.strip()
        
        # –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ markdown –±–ª–æ–∫–∏
        if result.startswith("```"):
            result = result.split("```")[1]
            if result.startswith("json"):
                result = result[4:]
        
        return json.loads(result)
    
    @staticmethod
    async def generate_recipe(dish_name: str, products: str) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç –±–ª—é–¥–∞"""
        prompt = f"""–°–æ–∑–¥–∞–π –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç –¥–ª—è –±–ª—é–¥–∞: {dish_name}

–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã: {products}

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
üçΩÔ∏è [–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞]

–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:
‚Ä¢ –ü—Ä–æ–¥—É–∫—Ç - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
‚Ä¢ –ü—Ä–æ–¥—É–∫—Ç - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
...

–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:
1. –®–∞–≥ –ø–µ—Ä–≤—ã–π
2. –®–∞–≥ –≤—Ç–æ—Ä–æ–π
3. ...

‚è± –í—Ä–µ–º—è: XX –º–∏–Ω—É—Ç

–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞! üç¥

–í–∞–∂–Ω–æ:
- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
- –£–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
- –®–∞–≥–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–µ—Ç–∫–∏–º–∏ –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º–∏
- –†–µ—Ü–µ–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º"""

        response = client.chat.completions.create(
            model=GROQ_MODEL,
            messages=[{"role": "user", "content": prompt}],
            max_tokens=GROQ_MAX_TOKENS,
            temperature=0.7
        )
        
        return response.choices[0].message.content
